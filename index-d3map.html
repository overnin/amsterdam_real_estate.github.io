<!DOCTYpE html>
<meta charset="utf-8">
<html>
   <head>
      <title>
         Amsterdam Real Estate Explorer 
      </title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      
      <link rel="stylesheet" type="text/css" href="css/map.css">
      <!-- D3 -->
      <!--
      <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
      <script src="http://d3js.org/queue.v1.min.js"></script>
      -->
      <script src="js/d3.js" charset="utf-8"></script>
      <script src="js/queue.v1.min.js" charset="utf-8"></script>
      <script src="js/colorbrewer.js" charset="utf-8"></script>
      <link rel="stylesheet" type="text/css" href="css/colorbrewer.css"></link>
      <!--Leaflet / Mapbox 
      <script src='https://api.mapbox.com/mapbox.js/v2.3.0/mapbox.js'></script>
      <link href='https://api.mapbox.com/mapbox.js/v2.3.0/mapbox.css' rel='stylesheet' /></script>
       -->
      <script src='js/mapbox.js'></script>
      <link href='css/mapbox.css' rel='stylesheet' />
      <link rel="stylesheet" href="css/bootstrap.min.css"/>
      <script src='js/mapbox_bootstrap_height_fix.js'></script>

      <!--
      <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    -->
   </head>
<body>
   <div class="container-fluid" style="height:100%">
   <div class="row" style="height:100%">
     <div class="col-md-3">Evolution of the price per square meter in amsterdam on funda website.</div>
     <div class="col-md-9">
        <div id='map' style="min-height:300px"></div>
     </div>
   </div>
 </div>
   <script>
    var width = 1440,
    height = 800;

    var center_lng = 4.9,
        center_lat = 52.36,
        month_index = 6,
        radius_limit = 10;

    NL = d3.locale(
      {
        "decimal": ",",
        "thousands": ".",
        "grouping": [3],
        "currency": ["â‚¬", ""],
        "dateTime": "%a %b %e %X %Y",
        "date": "%m/%d/%Y",
        "time": "%H:%M:%S",
        "periods": ["AM", "PM"],
        "days": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"],
        "shortDays": ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
        "months": ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
        "shortMonths": ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]
      }
      );


    queue()
      .defer(d3.json, 'json/amsterdam_admin_level_3_adjusted_centroid.json')
      .defer(d3.json, 'json/amsterdam_admin_level_3_aggregate.json')
      .await(buildViz);

    L.mapbox.accessToken = 'pk.eyJ1Ijoib2xpdmllcnZlcm5pbiIsImEiOiJjaWtzNjk5MXcwYXh6dW1tMWlubTlyc2JyIn0.aub3AlNziJHJh8TvhhOUJw';
    var map = L.mapbox.map('map', 'mapbox.streets')
          .setView([center_lat, center_lng], 12);
    resize(); 

    function buildViz(error, areas, aggregates) {
        if (error) return console.error(error);

        
        //map.featureLayer.setGeoJSON(areas);

        //data preprocess to be done in python
        areas.features.forEach(function(area) {
          i = aggregates.findIndex(function(aggregate) {
            return aggregate.name == area.properties.Gebied;
          });
          aggregates[i].representative_point = area.properties.representative_point;
        });

        aggregates.forEach(function(d) {
          d.LatLng = new L.LatLng(d.representative_point.coordinates[1], d.representative_point.coordinates[0]);
        });

        aggregates = aggregates.filter(function(d) {
          length = d["stats_per_month"].length - 1;
          return d["stats_per_month"][length]['price_square_meter_mean'] != 0;
        });

        price_domain = d3.extent(aggregates, function(elt) {
          length = elt["stats_per_month"].length - 1;
          return elt["stats_per_month"][length]['price_square_meter_mean'];
        });

        var price_color = d3.scale.quantize()
          .domain(price_domain)
          .range(colorbrewer.OrRd[3]);
        /*
        aggregates.forEach(function(d) { 
          //map.addLayer(L.circle([d.representative_point.coordinates[1], d.representative_point.coordinates[0]], 10));
        });*/

        var svg = d3.select(map.getPanes().overlayPane).append("svg")
            .style("position", "relative")
            //.attr("class", "leaflet-zoom-animated")
            //.attr("width", window.innerWidth)
            //.attr("height", window.innerHeight);

        // Append <g> to svg
        var g = svg
          .append("g")
          .attr("class", "leaflet-zoom-hide");
      
        /*
         var path = d3.geo.path()
           .projection(function(d) {
               d.LatLng = new L.LatLng(d[1], d[0]);
               return [map.latLngToLayerPoint(d.LatLng).x, map.latLngToLayerPoint(d.LatLng).y];
            });
        */
        function projectPoint(x, y) {
           var point = map.latLngToLayerPoint(new L.LatLng(y, x));
           this.stream.point(point.x, point.y);
        }

        var transform = d3.geo.transform({point: projectPoint}),
        path = d3.geo.path().projection(transform);


        var paths_container   = g.append("g").attr("id", "paths"),
            circles_container = g.append("g").attr("id", "circles"),
            details_container = g.append("g").attr("id", "details");

        var paths = paths_container.selectAll("path")
          .data(areas.features)
          .enter()
          .append("path")
          .attr("fill", function(d) {
            i = aggregates.findIndex(function(aggregate) {
              return aggregate.name == d.properties.Gebied;
              });
            if (i == -1) {
              return "#f0f0f0";
            }
            length = aggregates[i]["stats_per_month"].length - 1;
            return price_color(aggregates[i]["stats_per_month"][length]['price_square_meter_mean']);})
          .style("opacity", ".7")
          .attr("stroke-width", "3")

        var circle_container = circles_container.selectAll(".circle")
            .data(aggregates)
            .enter()
            .append("g")
            .attr("class", "circle")

        circle_container
            .append("circle")
            /*.style("fill", function(d) {
              length = d["stats_per_month"].length - 1;
              //return price_color(d["stats_per_month"][length]['price_square_meter_mean']);
              return "brown"})*/
            .style("stroke", "grey")
            .style("stroke-width", "1")
            //.style("opacity", ".2")
        circle_container
            .append("text")
            .attr("text-anchor", "middle")
                  


        var details = details_container.selectAll(".detail")
            .data(aggregates, function(d) {return d["name"];})
            .enter()
            .append("g")
            .style('opacity', '0')
            .style('visibility', 'hidden')
            .style('pointer-event', 'none')
            
        var boxes = details
            .append("rect")
            .style('fill', 'white')
            .attr('x', '0')
            .attr('y', '-10')
            .attr('height', "100")
            .attr('width', "200")

        var texts = details
            .append('text')
            .attr('x', '5')
            .attr('y', '5')

         map.on("viewreset", reset);
         reset();
         
         function reset() {
            var bounds = path.bounds(areas),
                topLeft = bounds[0],
                bottomRight = bounds[1];

            svg.attr("width", bottomRight[0] - topLeft[0])
               .attr("height", bottomRight[1] - topLeft[1])
               .style("left", topLeft[0] + "px")
               .style("top", topLeft[1] + "px");

            g.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");

            paths.attr("d", path);
            circles_container.selectAll(".circle")
              .attr("transform", function(d) {
              x = map.latLngToLayerPoint(d.LatLng).x;
              y = map.latLngToLayerPoint(d.LatLng).y;
              return "translate("+ x +' '+ y +')'})
            circles_container.selectAll(".circle").selectAll("circle")
                  .attr("r", get_radius)
                  .attr("fill", get_color)
            circles_container.selectAll(".circle").selectAll("text")
                  .text(get_percent_rounded)
                  .attr("text-anchor", get_label_anchor)
                  .attr("fill", get_label_color)
                  .attr("font-size", get_label_size)
                  .attr("transform", get_label_position)

            details.attr("transform", function(d) {
              x = map.latLngToLayerPoint(d.LatLng).x + 10;
              y = map.latLngToLayerPoint(d.LatLng).y;
              return "translate("+ x +' '+ y +')'})
            //circles.attr("cx", function(d) { return map.latLngToLayerPoint(d.LatLng).x; })
            //circles.attr("cy", function(d) { return map.latLngToLayerPoint(d.LatLng).y;} )
            texts.html(get_text);
        }

       /*
        var boxes = areas
            .append("rect")
            .style('fill', 'white')
            .attr('height', "100")
            .attr('width', "100")


        var details = areas
            .append('text')
            .html('this is it');
        */
        /*
        var tooltip = g
          .append("g")
          .attr("class", 'tooltip')
          .style("position", "absolute")
          .style("visibility", "hidden");

        tooltip
          .append("rect")
          .attr('height', "100")
          .attr('width', "100")
          .style('fill', 'white')

        tooltip
          .append("text")
          .html("a simple tooltip");
        */

        circle_container.on("mouseenter", function (d){
              details.filter(function(area) {
                return d['name'] == area['name'];})
                .style('visibility', 'visible')
                .transition()
                .delay(100)
                .duration(400)
                .style('opacity', '.9')
              paths.filter(function(area) {
                  return d['name'] == area.properties.Gebied;})
                .attr("stroke", "black");
              return d3.select(this).style("opacity", "1");
            })
            .on("mousemove", function(d){
              return 
              /*return tooltip
              .attr("x", (map.latLngToLayerPoint(d.LatLng).x + 10))
              .attr("y", (map.latLngToLayerPoint(d.LatLng).y +10));*/
            })
            .on("mouseleave", function (d){
              details.filter(function(area) {
                return d['name'] == area['name'];})
                .transition()
                .delay(100)
                .duration(200)
                .style("opacity", "0")
                .style('visibility', 'hidden');
              paths.filter(function(area) {
                  return d['name'] == area.properties.Gebied;})
                //.attr("fill", "#bdbdbd")
                .attr("stroke", "none");
              return d3.select(this).style("opacity", ".8");
            });
            //.attr("r", function(d) {return d.sold_per_month['2014-10']})

        function get_percent(d) {
          return precentage_increase(d.stats_per_month[month_index-4].price_square_meter_mean, d.stats_per_month[month_index].price_square_meter_mean);
        }

        function get_percent_rounded(d) {
          percent = get_percent(d);
          if (Math.abs(percent) >= .01) { 
            return NL.numberFormat("+%")(get_percent(d));
          }
           return NL.numberFormat("+.1%")(get_percent(d));
        }

        function get_radius(d) {
           percent = get_percent(d)
           //return 0.001* Math.sqrt(d.stats_per_month[month_index].sold_percent * 100) * Math.pow(2, map.getZoom());
           return  Math.sqrt(0.5 * Math.abs(percent) * Math.pow(2, map.getZoom())) ;
         }

         function get_color(d) {
            percent = get_percent(d)
            color = "red";
            if (percent > 0) {
              color = "green";
            }
            return color
         }

         function get_label_anchor(d) {
           r = get_radius(d)
           if (r > radius_limit) {
            return "middle";
           }
           return "start"; 
         }

         function get_label_size(d) {
           r = get_radius(d)
           if (r > radius_limit) {
            return r/2 +2;
           }
           return 10; 
         }

         function get_label_color(d) {
            r = get_radius(d)
            if (r > radius_limit) {
              return "white";
            } 
            return "black";
         }

         function get_label_position(d){
            r = get_radius(d)
            if (r > radius_limit) {
              return "translate(0 3)";
            }
            return "translate("+(r+5)+" 3)"; 
         }

         function get_text(d) {
            detail = '<tspan x="3" style="text-decoration:underline;font-size:1.5em;">' +d['name']+ '</tspan>'
            detail += '<tspan x="3" y="1.8em">' + NL.numberFormat("$f")(d.stats_per_month[month_index].price_square_meter_mean) + ' m2</tspan>';
            percent = precentage_increase(d.stats_per_month[month_index-4].price_square_meter_mean, d.stats_per_month[month_index].price_square_meter_mean)
            if (percent > 0) {
              color = 'green';
            } else {
              color = 'red';
            }
            detail += '<tspan style="stroke:'+color+'">  ' + NL.numberFormat("+.2%")(percent) + '</tspan>';

            detail += '<tspan x="3" y="3em">' + d.stats_per_month[month_index].sold_count + ' sold properties</tspan>';
            percent = precentage_increase(d.stats_per_month[month_index-4].sold_percent, d.stats_per_month[month_index].sold_percent)
            if (percent > 0) {
              color = 'green';
            } else {
              color = 'red';
            }
            detail += '<tspan style="stroke:'+color+'">  ' + NL.numberFormat("+.2%")(percent) + '</tspan>';
            return detail;
         }

         function round_2decimal(a) {
          return Math.round(100 * a) / 100;
         }
         
         function precentage_increase(a, b) {
          return ((b-a) / a)
         }

        function update(e) {
            //translateSVG();
            //paths.attr('d', path)
            areasbox.attr('transform', function(d) {
              return 'translate('+map.latLngToLayerPoint(d.LatLng).x +' '+map.latLngToLayerPoint(d.LatLng).y +')'})
            circles.attr("cx", 0)
            //boxes.attr('x', 20)
            //details.attr('transform', 'translate( 20 20)')
            circles.attr("cy", 0)
            //boxes.attr('y', 0)
            circles.attr("r", get_radius);
        }

        function update_month() {
            circles.transition()
              .duration(100)
              .attr("r", get_radius);
        }
        /*
        function translateSVG() {
            var viewBoxLeft = document.querySelector("svg.leaflet-zoom-animated").viewBox.animVal.x;
            var viewBoxTop = document.querySelector("svg.leaflet-zoom-animated").viewBox.animVal.y;
            // Reszing width and height incase of window resize
            svg.attr("width", window.innerWidth)
            svg.attr("height", window.innerHeight +200)
            // Adding the ViewBox attribute to our SVG to contain it
            svg.attr("viewBox", function () {
                return "" + viewBoxLeft + " " + (viewBoxTop) + " "  + window.innerWidth + " " + (window.innerHeight + 200);
            });
            // Adding the style attribute to our SVG to transkate it
            svg.attr("style", function () {
                return "transform: translate3d(" + viewBoxLeft + "px, " + viewBoxTop + "px, 0px);";
            });
        }*/

        /*map.on("moveend", update);
        update();*/

        /*
        var id = setInterval(function() {
          if (month_index >= aggregates[0].stats_per_month.length - 1) {
            clearInterval(id);
            return;
          }
          month_index++;
          d3.select('#month').text(aggregates[0].stats_per_month[month_index].month);
          update_month();
        }, 1000);
        */
      };
    /*      
    var svg = d3.select(map.getPanes().overlayPane).append("svg")
       .attr("class", "leaflet-zoom-animated")
       .attr("width", window.innerWidth)
       .attr("height", window.innerHeight);

    // Append <g> to svg
    var g = svg.append("g").attr("class", "leaflet-zoom-hide");
    */
   /*
    var svg = d3.select("#map").append("svg")
        .attr("width", width)
        .attr("height", height);
   
	  var projection = d3.geo.mercator()
		  .center([4.9, 52.36])
	    .scale(650000)
	    .translate([width / 2, height / 2 -95]);

	  var path = d3.geo.path()
	    .projection(projection);

    d3.json("json/amsterdam_admin_level_3.topo.json", function(error, amsterdam) {
        if (error) return console.error(error);

        var admin	= topojson.feature(amsterdam, amsterdam.objects.amsterdam_admin_level_3);

        g.append("path")
          .datum(admin)
          .attr("d", path)
          .attr("fill", "none")
          .attr("stroke", "black")
  
    });*/
      </script>
</body>
</html>